---
id: 67d1a99d10fd509c88faf3bf
title: React中的数据获取是如何工作的？
challengeType: 19
dashedName: how-does-data-fetching-work-in-react
---

# --description--

React应用程序通常依赖外部API和数据库来获取动态内容。要访问这些API和数据库中的数据，你需要使用一些数据获取技术。

让我们来看看React中的数据获取是如何工作的，以及你可以使用的不同数据获取选项。

React对如何获取数据没有固定的看法，这意味着在基本层面上，你可以使用所有现代浏览器都支持的内置Fetch API。

你也可以使用Axios和SWR。Axios是基于XMLHttpRequest对象构建的基于Promise的HTTP请求库，SWR是Vercel团队创建的用于数据获取的React钩子。

让我们从一个示例开始。首先你需要导入`useState`和`useEffect`钩子：

```js
import { useState, useEffect } from "react";
```

然后你需要创建三个名为`loading`、`data`和`error`的状态变量：

```js
const [data, setData] = useState(null);
const [loading, setLoading] = useState(true);
const [error, setError] = useState(null);
```

`loading`变量将跟踪数据是否仍在获取中。`data`变量代表数据本身，`error`变量将捕获在数据获取过程中可能发生的任何错误。

由于数据获取是一个副作用，最好在`useEffect`钩子中使用Fetch API。

这是一个示例：

```js
useEffect(() => {
  fetch("https://jsonplaceholder.typicode.com/posts")
    .then((res) => res.json())
    .then((data) => {
      setData(data);
      setLoading(false);
    })
    .catch((err) => {
      setError(err);
      setLoading(false);
    });
}, []);
```

这个`useEffect`使用Fetch API获取数据并设置所有状态。

你可以通过使用`async`/`await`而不是`.then()`语法来改进代码。这意味着你必须在`useEffect`内部有一个单独的函数，因为你不能用`async`关键字前缀`useEffect`：

```js
useEffect(() => {
  const fetchData = async () => {
    try {
      const res = await fetch("https://jsonplaceholder.typicode.com/posts");

      if (!res.ok) {
        throw new Error("网络响应不正常");
      }

      const data = await res.json();
      setData(data);
    } catch (err) {
      setError(err);
    } finally {
      setLoading(false);
    }
  };

  fetchData();
}, []);
```

然后你可以继续使用所有这些状态来渲染来自API的数据。

这是完整的代码：

```jsx
import { useState, useEffect } from "react";

const FetchPosts = () => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const res = await fetch("https://jsonplaceholder.typicode.com/posts");

        if (!res.ok) {
          throw new Error("网络响应不正常");
        }

        const data = await res.json();
        setData(data);
      } catch (err) {
        setError(err);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  if (loading) {
    return <p>加载中...</p>;
  }

  if (error) {
    return <p>{error.message}</p>;
  }

  return (
    <ul>
      {data.map((post) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  );
};

export default FetchPosts;
```

在UI中，当数据正在获取时，你会在屏幕上看到`加载中...`，然后根据数据获取是否成功显示数据或错误。

记住我们还谈到了使用Axios和SWR进行数据获取。让我们看一个使用Axios的示例。

首先你需要从命令行安装Axios，如下所示：

```sh
npm i axios
```

然后你需要像这样导入Axios：

```js
import axios from "axios";
```

然后你可以使用之前的状态变量，并使用`axios.get`从API获取数据：

```js
const [data, setData] = useState(null);
const [loading, setLoading] = useState(true);
const [error, setError] = useState(null);

useEffect(() => {
  const fetchData = async () => {
    try {
      const res = await axios.get(
        "https://jsonplaceholder.typicode.com/users"
      );
      setData(res.data);
    } catch (err) {
      setError(err);
    } finally {
      setLoading(false);
    }
  };

  fetchData();
}, []);
```

你可能已经注意到这个示例中没有`await res.json()`这一行。这是因为Axios会自动解析JSON，所以不需要这一行。

我们要看的最后一个示例是使用`useSWR`钩子来获取数据。

就像Axios一样，你需要像这样安装SWR：

```sh
npm install swr
```

然后你需要像这样将`useSWR`钩子导入到文件中：

```js
import useSWR from "swr";
```

与之前的示例相比，SWR语法要短得多。你需要做的是创建一个fetcher函数并将其作为第二个参数传递给`useSWR`钩子（端点是第一个参数）。

你还可以从`useSWR`钩子中解构出数据和错误状态，所以你不需要`useState`钩子。

这是语法：

```js
const fetcher = (url) => fetch(url).then((res) => res.json());
const { data, error } = useSWR(endpoint, fetcher);
```

注意这里的"fetcher"名称只是一个约定，所以你可以随意命名这个变量。

这是一个从JSON Placeholder API获取待办事项的组件：

```jsx
import useSWR from "swr";

const fetcher = (url) => fetch(url).then((res) => res.json());

const FetchTodos = () => {
  const { data, error } = useSWR(
    "https://jsonplaceholder.typicode.com/todos",
    fetcher
  );

  if (!data) {
    return <h2>加载中...</h2>;
  }
  if (error) {
    return <h2>错误: {error.message}</h2>;
  }

  return (
    <>
      <h2>待办事项</h2>
      <div>
        {data.map((todo) => (
          <h3 key={todo.id}>{todo.title}</h3>
        ))}
      </div>
    </>
  );
};

export default FetchTodos;
```

正如你在之前的自定义钩子课程中学到的，数据获取是一个可以提取到自定义钩子中的逻辑。所以，如果你在多个组件和页面中获取数据，最好创建一个`useFetch`钩子。

这是一个使用SWR进行数据获取的`useFetch`钩子：

```jsx
import useSWR from "swr";

const fetcher = (url) => fetch(url).then((res) => res.json());

const useFetch = (url) => {
  const { data, error } = useSWR(url, fetcher);

  return {
    data,
    loading: !data && !error,
    error,
  };
};

export default useFetch;
```

这是如何使用`useFetch`钩子重写从JSON Placeholder API获取帖子的第一个示例：

```jsx
import useFetch from "./useFetch";

const FetchPosts = () => {
  const { data, loading, error } = useFetch(
    "https://jsonplaceholder.typicode.com/posts"
  );

  if (loading) {
    return <h2>加载中...</h2>;
  }

  if (error) {
    return <h2>{error.message}</h2>;
  }

  return (
    <>
      <h2>帖子</h2>
      <ul>
        {data.map((post) => (
          <li key={post.id}>{post.title}</li>
        ))}
      </ul>
    </>
  );
};

export default FetchPosts;
```

# --questions--

## --text--

在给定的示例中，`useSWR`钩子的两个参数是什么？

## --answers--

URL和缓存策略。

### --feedback--

第一个参数代表数据源，第二个处理数据检索。

---

API路由和fetcher函数。

### --feedback--

第一个参数代表数据源，第二个处理数据检索。

---

端点和fetcher函数。

---

键和配置对象。

### --feedback--

第一个参数代表数据源，第二个处理数据检索。

## --video-solution--

3

## --text--

为什么你必须在`useEffect`中处理数据获取逻辑？

## --answers--

因为数据获取应该只运行一次。

### --feedback--

获取数据会影响组件外部的事物，不应该阻塞渲染。

---

因为数据获取不应该成为渲染过程的一部分。

---

因为`useEffect`在组件渲染之前执行。

### --feedback--

获取数据会影响组件外部的事物，不应该阻塞渲染。

---

因为`useEffect`与渲染周期同步运行。

### --feedback--

获取数据会影响组件外部的事物，不应该阻塞渲染。

## --video-solution--

2

## --text--

Axios是基于什么构建的？

## --answers--

Fetch API。

### --feedback--

这是一个在Fetch之前用于发起HTTP请求的较旧API。

---

XMLHttpRequest对象。

---

WebSocket API。

### --feedback--

这是一个在Fetch之前用于发起HTTP请求的较旧API。

---

DOM API。

### --feedback--

这是一个在Fetch之前用于发起HTTP请求的较旧API。

## --video-solution--

2